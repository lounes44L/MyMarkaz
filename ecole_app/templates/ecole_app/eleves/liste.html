{% extends 'ecole_app/base_admin.html' %}

{% block title %}Liste des élèves - Gestion Markaz{% endblock %}

{% block page_title %}Liste des élèves{% endblock %}

{% block extra_css %}
<style>
    .checkbox-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        columns: 2;
    }
    
    /* Style pour les cases à cocher plus compactes */
    .checkbox-container label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }
    
    /* Rendre le formulaire plus compact */
    .compact-form .form-control {
        padding: 0.375rem 0.5rem;
    }
    
    .compact-form .mb-3 {
        margin-bottom: 0.75rem !important;
    }
</style>
{% endblock %}

{% block content %}

<!-- Sous-onglets Élèves actifs / Archives -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link {% if not archives_tab and not attente_tab %}active{% endif %}" href="{% url 'liste_eleves' %}">Élèves actifs</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if archives_tab %}active{% endif %}" href="{% url 'archives_eleves' %}">Archives</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if attente_tab %}active{% endif %}" href="{% url 'liste_attente' %}">Liste d'attente</a>
  </li>
</ul>

<!-- Formulaire d'ajout rapide -->


<!-- Filtres de tri -->
<!-- Barre de filtrage et actions -->


{% if not archives_tab %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center w-100 justify-content-between">
            <h5 class="card-title mb-0">Ajouter un élève</h5>
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#formAjoutComplet">
                    <i class="fas fa-plus"></i> Afficher/Masquer le formulaire
                </button>
            </div>
        </div>
    </div>
    <div class="collapse show" id="formAjoutComplet">
        <div class="card-body">
            <form method="post" action="{% url 'liste_eleves' %}" class="compact-form">
                {% csrf_token %}
                {% if form.errors %}
                <div class="alert alert-danger">
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }} :</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                <input type="hidden" name="ajout_complet" value="1">
                <div class="row">
                    <!-- Première ligne - Informations de base -->
                    <div class="col-md-4 mb-3">
                        {{ form.nom.label_tag }}
                        {{ form.nom }}
                        {% if form.nom.errors %}
                        <div class="invalid-feedback d-block">{{ form.nom.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.prenom.label_tag }}
                        {{ form.prenom }}
                        {% if form.prenom.errors %}
                        <div class="invalid-feedback d-block">{{ form.prenom.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.date_naissance.label_tag }}
                        {{ form.date_naissance }}
                        {% if form.date_naissance.errors %}
                        <div class="invalid-feedback d-block">{{ form.date_naissance.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Deuxième ligne - Affectation -->
                    <div class="col-md-12 mb-3">
                        {{ form.classes.label_tag }}
                        <div class="checkbox-container">
                            {{ form.classes }}
                        </div>
                        {% if form.classes.errors %}
                        <div class="invalid-feedback d-block">{{ form.classes.errors }}</div>
                        {% endif %}
                        {% if form.classes.help_text %}
                        <small class="form-text text-muted">{{ form.classes.help_text }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Troisième ligne - Coordonnées -->
                    <div class="col-md-6 mb-3">
                        {{ form.telephone.label_tag }}
                        {{ form.telephone }}
                        {% if form.telephone.errors %}
                        <div class="invalid-feedback d-block">{{ form.telephone.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.telephone_secondaire.label_tag }}
                        {{ form.telephone_secondaire }}
                        {% if form.telephone_secondaire.errors %}
                        <div class="invalid-feedback d-block">{{ form.telephone_secondaire.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.prenom_pere.label_tag }}
                        {{ form.prenom_pere }}
                        {% if form.prenom_pere.errors %}
                        <div class="invalid-feedback d-block">{{ form.prenom_pere.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.prenom_mere.label_tag }}
                        {{ form.prenom_mere }}
                        {% if form.prenom_mere.errors %}
                        <div class="invalid-feedback d-block">{{ form.prenom_mere.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12 mb-3">
                        {{ form.email.label_tag }}
                        {{ form.email }}
                        {% if form.email.errors %}
                        <div class="invalid-feedback d-block">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Quatrième ligne - Adresse -->
                    <div class="col-md-12 mb-3">
                        {{ form.adresse.label_tag }}
                        {{ form.adresse }}
                        {% if form.adresse.errors %}
                        <div class="invalid-feedback d-block">{{ form.adresse.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12 mb-3">
                        {{ form.remarque.label_tag }}
                        {{ form.remarque }}
                        {% if form.remarque.errors %}
                        <div class="invalid-feedback d-block">{{ form.remarque.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Ajouter
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalFormRapide">
                        <i class="fas fa-bolt me-1"></i> Formulaire rapide
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour formulaire rapide -->
<div class="modal fade" id="modalFormRapide" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajout rapide d'élève</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'liste_eleves' %}" class="compact-form">
                    {% csrf_token %}
                    <input type="hidden" name="ajout_rapide" value="1">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form_rapide.nom.label_tag }}
                            {{ form_rapide.nom }}
                            {% if form_rapide.nom.errors %}
                            <div class="invalid-feedback d-block">{{ form_rapide.nom.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_rapide.prenom.label_tag }}
                            {{ form_rapide.prenom }}
                            {% if form_rapide.prenom.errors %}
                            <div class="invalid-feedback d-block">{{ form_rapide.prenom.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_rapide.classes.label_tag }}
                            <div class="checkbox-container">
                                {{ form_rapide.classes }}
                            </div>
                            {% if form_rapide.classes.errors %}
                            <div class="invalid-feedback d-block">{{ form_rapide.classes.errors }}</div>
                            {% endif %}
                            {% if form_rapide.classes.help_text %}
                            <small class="form-text text-muted">{{ form_rapide.classes.help_text }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_rapide.creneaux.label_tag }}
                            <div class="checkbox-container">
                                {{ form_rapide.creneaux }}
                            </div>
                            {% if form_rapide.creneaux.errors %}
                            <div class="invalid-feedback d-block">{{ form_rapide.creneaux.errors }}</div>
                            {% endif %}
                            {% if form_rapide.creneaux.help_text %}
                            <small class="form-text text-muted">{{ form_rapide.creneaux.help_text }}</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Ajouter rapidement
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endif %}
<!-- Liste des élèves -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0">Élèves ({{ eleves|length }})</h5>
            </div>
            <div class="col-auto">
                <div class="input-group">
                    <input type="text" id="searchEleves" class="form-control" placeholder="Rechercher...">
                    <button class="btn btn-outline-secondary" type="button" title="Rechercher" aria-label="Rechercher">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="tableEleves">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Classe</th>
                        <th>Âge</th>
                        <th>Téléphone</th>
                        <th>Email</th>
                        {% if archives_tab %}<th>Motif d'archivage</th>{% endif %}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in eleves %}
                    <tr>
                        <td>{{ eleve.nom }}</td>
                        <td>{{ eleve.prenom }}</td>
                        <td>
    {% if eleve.classes.all %}
        {% for classe in eleve.classes.all %}
            <span class="badge bg-primary me-1">{{ classe.nom }}</span>
        {% empty %}
            <span class="text-muted">Aucune classe</span>
        {% endfor %}
    {% endif %}
</td>
                        <td>{% if eleve.age %}{{ eleve.age }} ans{% else %}-{% endif %}</td>
                        <td>{{ eleve.telephone|default:"-" }}</td>
                        <td>{{ eleve.email|default:"-" }}</td>
                        {% if archives_tab %}<td>{{ eleve.motif_archive|default:"-" }}</td>{% endif %}
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a class="btn btn-primary btn-sm" href="{% url 'detail_eleve' eleve.id %}" title="Voir les détails de l'élève">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a class="btn btn-success btn-sm" href="{% url 'carnet_pedagogique' eleve.id %}" title="Carnet pédagogique">
                                    <i class="fas fa-book"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger" title="Supprimer" 
                                        data-bs-toggle="modal" data-bs-target="#deleteModal" 
                                        data-id="{{ eleve.id }}" 
                                        data-name="{{ eleve.nom }} {{ eleve.prenom }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% if not archives_tab %}
                                <button type="button" class="btn btn-warning btn-sm" title="Archiver" 
                                        data-bs-toggle="modal" data-bs-target="#archiveModal" 
                                        data-id="{{ eleve.id }}" 
                                        data-name="{{ eleve.nom }} {{ eleve.prenom }}">
                                    <i class="fas fa-archive"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-outline-primary btn-sm" title="Désarchiver" 
                                        data-bs-toggle="modal" data-bs-target="#desarchiveModal" 
                                        data-id="{{ eleve.id }}" 
                                        data-name="{{ eleve.nom }} {{ eleve.prenom }}">
                                    <i class="fas fa-undo"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if archives_tab %}8{% else %}7{% endif %}" class="text-center">Aucun élève enregistré</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

<!-- Modal d'archivage élève -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'archiver_eleve' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Archiver l'élève</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="eleve_id" id="archiveEleveId">
          <div class="mb-3">
            <label for="archiveMotif" class="form-label">Motif de l'archivage</label>
            <textarea class="form-control" name="motif_archive" id="archiveMotif" rows="3" required></textarea>
          </div>
          <div class="alert alert-warning" id="archiveEleveName"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-warning">Archiver</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% include 'ecole_app/eleves/desarchive_modal.html' %}

{% if not archives_tab %}
<!-- Boutons Importer / Exporter à la toute fin de la page -->
<div class="d-flex justify-content-end gap-2 mt-4">
    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#envoiMasseModal" title="Envoyer les identifiants à tous les élèves">
        <i class="fas fa-envelope me-1"></i> Envoyer tous les identifiants
    </button>
    <a href="{% url 'export_eleves_excel' %}" class="btn btn-success" title="Exporter la liste des élèves">
        <i class="fas fa-file-excel me-1"></i> Exporter
    </a>
    <button type="button" class="btn btn-primary" id="importButton" title="Importer une liste d'élèves">
        <i class="fas fa-file-import me-1"></i> Importer
    </button>
</div>
{% endif %}

<!-- Modal d'importation Excel -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importer des élèves depuis Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" action="{% url 'liste_eleves' %}">
                    {% csrf_token %}
                    <input type="hidden" name="import_excel" value="1">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">
                            Fichier Excel
                            <span tabindex="0" data-bs-toggle="tooltip" data-bs-placement="right" title="Le fichier doit être au format .xlsx ou .xls et contenir les colonnes : Nom, Prénom, Classe, Créneau, Date de naissance, Téléphone, Email, Adresse" data-style="cursor:pointer;">
                                <i class="fas fa-info-circle text-primary small ms-1"></i>
                            </span>
                        </label>
                        <input type="file" class="form-control" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Le fichier Excel doit avoir les colonnes : Nom, Prénom, Date de naissance, Téléphone, Email, Adresse
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Importer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer l'élève <strong id="deleteName"></strong> ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm" title="Supprimer l'élève">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal d'envoi en masse des identifiants -->
<div class="modal fade" id="envoiMasseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Envoyer les identifiants à tous les élèves</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'envoyer_tous_identifiants' %}">
                    {% csrf_token %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Cette action va envoyer les identifiants de connexion à tous les élèves affichés dans la liste actuelle ({{ eleves|length }} élèves).
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmEnvoi" name="confirm" required>
                            <label class="form-check-label" for="confirmEnvoi">
                                Je confirme vouloir envoyer les identifiants à tous les élèves affichés
                            </label>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-envelope me-1"></i> Envoyer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<!-- Modal d'importation Excel -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importer des élèves depuis Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" action="{% url 'liste_eleves' %}">
                    {% csrf_token %}
                    <input type="hidden" name="import_excel" value="1">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">
                            Fichier Excel
                            <span tabindex="0" data-bs-toggle="tooltip" data-bs-placement="right" title="Le fichier doit être au format .xlsx ou .xls et contenir les colonnes : Nom, Prénom, Classe, Créneau, Date de naissance, Téléphone, Email, Adresse" data-style="cursor:pointer;">
                                <i class="fas fa-info-circle text-primary small ms-1"></i>
                            </span>
                        </label>
                        <input type="file" class="form-control" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Le fichier Excel doit avoir les colonnes : Nom, Prénom, Date de naissance, Téléphone, Email, Adresse
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Importer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Soumettre le formulaire automatiquement lors du changement de sélection
    document.querySelectorAll('.autosubmit').forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    });

    // Gestion du modal d'archivage élève
    const archiveModal = document.getElementById('archiveModal');
    if (archiveModal) {
        archiveModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const eleveId = button.getAttribute('data-id');
            const eleveName = button.getAttribute('data-name');
            document.getElementById('archiveEleveId').value = eleveId;
            document.getElementById('archiveEleveName').textContent = 'Élève : ' + eleveName;
            document.getElementById('archiveMotif').value = '';
        });
    }

    // Gestion du modal de désarchivage élève
    const desarchiveModal = document.getElementById('desarchiveModal');
    if (desarchiveModal) {
        desarchiveModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const eleveId = button.getAttribute('data-id');
            const eleveName = button.getAttribute('data-name');
            document.getElementById('desarchiveEleveId').value = eleveId;
            document.getElementById('desarchiveEleveName').textContent = 'Élève : ' + eleveName;
        });
    }

    // Recherche dans le tableau
    document.getElementById('searchEleves').addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('#tableEleves tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchValue) ? '' : 'none';
        });
    });
    
    // Configuration du modal de suppression
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            const name = button.getAttribute('data-name');
            
            document.getElementById('deleteName').textContent = name;
            document.getElementById('deleteForm').action = `/eleves/${id}/supprimer/`;
        });
    }
    
    // Initialisation manuelle du modal d'import pour éviter les conflits JS
    document.addEventListener('DOMContentLoaded', function() {
        const importButton = document.getElementById('importButton');
        const importModal = document.getElementById('importModal');
        
        if (importButton && importModal) {
            importButton.addEventListener('click', function() {
                const modal = new bootstrap.Modal(importModal);
                modal.show();
            });
        }
        
        // Initialisation manuelle des tooltips
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => {
            new bootstrap.Tooltip(tooltip);
        });
    });
</script>
{% endblock %}

{% extends 'ecole_app/base.html' %}
{% load static %}

{% block title %}Quiz: {{ quiz.titre }}{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        border-left: 4px solid #5e72e4;
        margin-bottom: 20px;
    }
    .timer {
        position: sticky;
        top: 20px;
        z-index: 100;
    }
    .timer-warning {
        color: #fb6340;
    }
    .timer-danger {
        color: #f5365c;
        animation: pulse 1s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête du quiz -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-8">
                            <h4 class="mb-1">{{ quiz.titre }}</h4>
                            <p class="text-sm text-muted mb-2">
                                <i class="fas fa-book me-1"></i> Module: {{ quiz.module.titre }}
                                <span class="mx-2">|</span>
                                <i class="fas fa-question-circle me-1"></i> {{ quiz.questions.count }} questions
                            </p>
                            <p>{{ quiz.description|linebreaks }}</p>
                        </div>
                        <div class="col-md-4">
                            {% if quiz.temps_limite %}
                            <div class="card bg-gradient-info text-white timer">
                                <div class="card-body p-3">
                                    <div class="row">
                                        <div class="col-8">
                                            <div class="numbers">
                                                <p class="text-sm mb-0 text-white font-weight-bold">Temps restant</p>
                                                <h5 class="font-weight-bolder text-white mb-0" id="timer">
                                                    {{ quiz.temps_limite }}:00
                                                </h5>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <div class="icon icon-shape bg-white shadow text-center border-radius-md">
                                                <i class="fas fa-clock text-lg opacity-10 text-info" aria-hidden="true"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Questions du quiz -->
    <form method="post" id="quiz-form">
        {% csrf_token %}
        
        {% for question in questions %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card question-card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Question {{ forloop.counter }}</h5>
                            <span class="badge bg-primary">{{ question.points }} point{% if question.points > 1 %}s{% endif %}</span>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <p class="mb-4">{{ question.texte }}</p>
                        
                        {% if question.type == 'choix_unique' %}
                        <div class="form-group">
                            {% for choix in question.choix.all %}
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="choix_{{ choix.id }}" value="{{ choix.id }}">
                                <label class="form-check-label" for="choix_{{ choix.id }}">
                                    {{ choix.texte }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% elif question.type == 'choix_multiple' %}
                        <div class="form-group">
                            {% for choix in question.choix.all %}
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="question_{{ question.id }}" id="choix_{{ choix.id }}" value="{{ choix.id }}">
                                <label class="form-check-label" for="choix_{{ choix.id }}">
                                    {{ choix.texte }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% elif question.type == 'vrai_faux' %}
                        <div class="form-group">
                            {% for choix in question.choix.all %}
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="choix_{{ choix.id }}" value="{{ choix.id }}">
                                <label class="form-check-label" for="choix_{{ choix.id }}">
                                    {{ choix.texte }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% elif question.type == 'texte_court' %}
                        <div class="form-group">
                            <input type="text" class="form-control" name="question_{{ question.id }}" placeholder="Votre réponse">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="row mt-4 mb-5">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-lg btn-primary">
                    <i class="fas fa-check me-2"></i> Terminer le quiz
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        {% if quiz.temps_limite %}
        // Timer pour le quiz
        let tempsLimite = {{ quiz.temps_limite }} * 60; // Conversion en secondes
        const timerElement = $('#timer');
        
        const timerInterval = setInterval(function() {
            tempsLimite--;
            
            if (tempsLimite <= 0) {
                clearInterval(timerInterval);
                // Soumettre automatiquement le formulaire
                $('#quiz-form').submit();
                return;
            }
            
            const minutes = Math.floor(tempsLimite / 60);
            const secondes = tempsLimite % 60;
            
            // Formater l'affichage
            timerElement.text(
                minutes.toString().padStart(2, '0') + ':' + 
                secondes.toString().padStart(2, '0')
            );
            
            // Ajouter des classes d'alerte
            if (tempsLimite < 60) { // Moins d'une minute
                timerElement.removeClass('timer-warning').addClass('timer-danger');
            } else if (tempsLimite < 300) { // Moins de 5 minutes
                timerElement.addClass('timer-warning');
            }
        }, 1000);
        {% endif %}
    });
</script>
{% endblock %}
